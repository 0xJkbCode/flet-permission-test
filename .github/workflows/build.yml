name: Flet APK Build (on Windows Runner)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.11
  FLET_CLI_VERSION: 0.28.3
  # Ù†Ø³ØªØ®Ø¯Ù… 3.27.0 Ø£Ùˆ 3.28.0ØŒ ÙƒÙ„Ø§Ù‡Ù…Ø§ Ø£Ø«Ø¨Øª Ù†Ø¬Ø§Ø­Ù‡ Ø£Ùˆ Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ…
  FLUTTER_VERSION_TAG: 3.28.0 
  
jobs:
  build:
    runs-on: windows-latest # ğŸš¨ ØªØºÙŠÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ù„Ù‰ ÙˆÙŠÙ†Ø¯ÙˆØ² ğŸš¨

    steps:
    - name: ğŸ›‘ Checkout code
      uses: actions/checkout@v4
      
    # 1. ğŸ¯ ØªØ«Ø¨ÙŠØª Flutter (Ø§Ù„Ø­Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© ØªÙˆØ§ÙÙ‚ Dart)
    # Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ subosito/flutter-action@v2 Ù„Ø£Ù†Ù‡ Ù…ÙˆØ«ÙˆÙ‚ ÙÙŠ ØªÙˆÙÙŠØ± Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
    - name: Setup Specific Flutter Version (${{ env.FLUTTER_VERSION_TAG }})
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION_TAG }}
        channel: stable
        
    # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Python
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # 3. ØªØ«Ø¨ÙŠØª Flet
    - name: âš™ï¸ Install Flet CLI
      # Ø§Ù„Ø£ÙˆØ§Ù…Ø± ØªØ¹Ù…Ù„ Ø¨Ù†ÙØ³ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù„Ù‰ Windows Shells
      run: |
        pip install flet-cli==${{ env.FLET_CLI_VERSION }}
        
    # 4. Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ (Ø®Ø·ÙˆØ© Ø¶Ø±ÙˆØ±ÙŠØ© Ø¹Ù„Ù‰ Windows Ø£ÙŠØ¶Ù‹Ø§)
    # ÙŠØ³ØªØ®Ø¯Ù… Windows Ù…Ø³Ø§Ø±Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ§Ù‹ Ù„Ù…Ù„ÙØ§Øª Android SDK
    - name: ğŸ” Accept Android Licenses
      run: yes | %ANDROID_HOME%\cmdline-tools\latest\bin\sdkmanager --licenses
      
    # 5. Ø¨Ù†Ø§Ø¡ APK
    - name: ğŸ”¨ Flet Build APK
      # ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠØ¦Ø© Flutter/Dart Ù…ÙØ¹Ø¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø§Ù„Ø¢Ù†.
      run: |
        flet build apk --release --skip-flutter-doctor `
          --build-number ${{ env.BUILD_NUMBER }} `
          --build-version ${{ env.BUILD_VERSION }} `
          --android-permissions android.permission.READ_CONTACTS=True `
          android.permission.WRITE_CONTACTS=True

    # 6. Ø±ÙØ¹ Ù…Ù„Ù APK
    - name: â¬†ï¸ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        # Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ù„Ù…Ù„Ù APK Ø¹Ù„Ù‰ Windows/Linux Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡
        path: build/app/outputs/flutter-apk/app-release.apk