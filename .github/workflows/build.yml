name: Parallel Build Test (Windows vs Linux)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-flet-app:
    # [المصفوفة]: بنعرف هنا المتغيرات بتاعتنا
    strategy:
      fail-fast: false # عشان لو وظيفة فشلت، التانية تكمل عادي
      matrix:
        # بنعرف نظام التشغيل اللي هنشتغل عليه
        os: [windows-latest, ubuntu-latest]
        
    # بنقول للوظيفة إنها تستخدم نظام التشغيل من المصفوفة
    runs-on: ${{ matrix.os }}

    steps:
    # ------------------ خطوات مشتركة ------------------

    - name: Checkout Main Project Repo
      uses: actions/checkout@v4
      with:
        path: main_project

    - name: Checkout Custom Build Template
      uses: actions/checkout@v4
      with:
        repository: 0xJkbCode/custom_flet_template
        path: custom_template

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Project Dependencies
      working-directory: ./main_project
      run: pip install .

    # ------------------ خطوات خاصة بويندوز فقط ------------------

    - name: Set up Flutter SDK (Windows Only)
      # بنستخدم الشرط ده عشان الخطوة دي تشتغل على ويندوز بس
      if: runner.os == 'Windows'
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.6'
        channel: 'stable'
        cache: true

    # ------------------ خطوات خاصة بلينكس فقط ------------------

    - name: Install Flutter System Dependencies (Linux Only)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update -y
        sudo apt-get install -y curl git unzip xz-utils zip libglu1-mesa clang cmake ninja-build pkg-config

    # ------------------ خطوة البناء (بتختلف لكل نظام) ------------------

    - name: Build APK (Windows)
      if: runner.os == 'Windows'
      working-directory: ./main_project
      run: flet build apk --verbose --no-rich-output --template ../custom_template

    - name: Build APK (Linux)
      if: runner.os == 'Linux'
      working-directory: ./main_project
      run: flet build apk --verbose --template ../custom_template

    # ------------------ خطوة الرفع (بتختلف لكل نظام) ------------------

    - name: Upload APK Artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: app-release-windows.apk
        path: main_project/build/apk/app-release.apk

    - name: Upload APK Artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: app-release-linux.apk
        path: main_project/build/apk/app-release.apk