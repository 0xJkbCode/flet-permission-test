name: APK Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.11
  FLET_CLI_VERSION: 0.28.3
  FLUTTER_VERSION_TAG: 3.28.0 # Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Dart 3.9+
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›‘ Checkout code
      uses: actions/checkout@v4

    # 1. ğŸ¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Workflow Ù„ØªØ«Ø¨ÙŠØª Flutter (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… flutter.yml Ø§Ù„Ù…ØªØ§Ø­ Ù„Ø¯ÙŠÙƒ)
    # Ù‡Ø°Ø§ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚ Ø¨Ø¶Ù…Ø§Ù† ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.
    - name: Setup Specific Flutter Version (${{ env.FLUTTER_VERSION_TAG }})
      uses: ./.github/workflows/flutter.yml # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ
      with:
        runs-on: ubuntu-latest
        channel: stable
        version: ${{ env.FLUTTER_VERSION_TAG }} # ØªÙ…Ø±ÙŠØ± 3.28.0

    # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Python
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # 3. ØªØ«Ø¨ÙŠØª Flet
    - name: âš™ï¸ Install Flet CLI
      run: |
        python -m pip install --upgrade pip
        pip install flet-cli==${{ env.FLET_CLI_VERSION }}
        
    # 4. Ù‚Ø¨ÙˆÙ„ ØªØ±Ø§Ø®ÙŠØµ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø¨Ù†Ø§Ø¡)
    - name: ğŸ” Accept Android Licenses
      # ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ù…ØªØ§Ø­Ø§Ù‹ Ø¨Ø¹Ø¯ ØªØ«Ø¨ÙŠØª Flutter
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    # 5. Ø¨Ù†Ø§Ø¡ APK Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Flutter Ø§Ù„Ù…ÙØ«Ø¨Ù‘ÙØª
    # Ù†Ø³ØªØ®Ø¯Ù… --skip-flutter-doctor Ù„Ø£Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª ØªÙ… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ø¨Ø± flutter.yml
    - name: ğŸ”¨ Flet Build APK
      run: |
        flet build apk --release --skip-flutter-doctor \
          --build-number $BUILD_NUMBER \
          --build-version $BUILD_VERSION \
          --android-permissions android.permission.READ_CONTACTS=True \
          android.permission.WRITE_CONTACTS=True

    # 6. Ø±ÙØ¹ Ù…Ù„Ù APK
    - name: â¬†ï¸ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: build/app/outputs/flutter-apk/app-release.apk