name: Build Flet Android APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    # استخدام Ubuntu هو الأسرع والأكثر شيوعًا في GitHub Actions
    runs-on: ubuntu-latest

    steps:
    # الخطوة 1: سحب الكود بتاعك
    - name: Checkout Repository
      uses: actions/checkout@v4

    # الخطوة 2: تثبيت Python بالإصدار المناسب
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # الخطوة 3 (الحاسمة): تثبيت Flutter SDK باستخدام الأداة الصحيحة والموثوقة
    - name: Set up Flutter SDK
      uses: subosito/flutter-action@v2
      with:
        # تحديد إصدار Flutter متوافق مع إصدارات Flet الحديثة
        flutter-version: '3.19.6'
        channel: 'stable'
        # تفعيل الكاش لتسريع عمليات البناء المستقبلية
        cache: true

    # الخطوة 4: تثبيت Flet CLI
    - name: Install Flet
      run: python -m pip install --upgrade pip && pip install flet

    # الخطوة 5 (الحاسمة): قبول تراخيص أندرويد باستخدام Flutter
    - name: Accept Android Licenses
      # استخدام --suppress-analytics لمنع إرسال بيانات استخدام لجوجل
      run: yes | flutter doctor --android-licenses --suppress-analytics

    # الخطوة 6: تنفيذ أمر البناء بالصيغة الصحيحة
    # استخدام الصيغة التي ثبت نجاحها معك
    # مع إزالة اسم الملف لأن Flet سيبحث عن main.py تلقائيًا
    - name: Build APK
      run: |
        flet build apk --verbose \
        --android-permissions android.permission.READ_CONTACTS=True \
        android.permission.WRITE_CONTACTS=True

    # الخطوة 7: رفع ملف الـ APK الناتج
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release.apk
        path: build/apk/app-release.apk