name: APK Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.11
  FLET_CLI_VERSION: 0.28.3
  # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø°ÙŠ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Dart 3.9+
  FLUTTER_VERSION_TAG: 3.28.0 
  
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›‘ Checkout code
      uses: actions/checkout@v4

    # 1. ğŸ”‘ Ù…Ù†Ø­ Ø¥Ø°Ù† Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ù…Ù„Ù action.sh
    # Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªØ­Ù„ Ù…Ø´ÙƒÙ„Ø© "Permission denied" ÙÙŠ Ø¨ÙŠØ¦Ø© Ubuntu
    - name: Grant Execute Permission to Action Script
      # ÙŠÙÙØªØ±Ø¶ Ø£Ù† Ù…Ø³Ø§Ø± action.sh Ù‡Ùˆ ÙÙŠ Ø¬Ø°Ø± Ø§Ù„Ù€ Action Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡ (Ø£Ùˆ ÙÙŠ Ù…Ø³Ø§Ø± Ù…Ø¹Ø±ÙˆÙ).
      # Ø¥Ø°Ø§ ÙƒØ§Ù† action.sh Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ .github/workflows/action.sh
      run: chmod +x ./action.sh
      # Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±ØŒ Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø£Ø¹Ù„Ø§Ù‡ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ù…ÙˆÙ‚Ø¹ action.sh Ø§Ù„ÙØ¹Ù„ÙŠ.
      
    # 2. ğŸ¯ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Workflow Ù„ØªØ«Ø¨ÙŠØª Flutter Ø¨Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    - name: Setup Specific Flutter Version (${{ env.FLUTTER_VERSION_TAG }})
      uses: ./.github/workflows/flutter.yml 
      with:
        runs-on: ubuntu-latest
        channel: stable
        version: ${{ env.FLUTTER_VERSION_TAG }} # Ù†Ù…Ø±Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø¯ÙŠØ« (3.28.0)

    # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Python
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # 4. ØªØ«Ø¨ÙŠØª Flet
    - name: âš™ï¸ Install Flet CLI
      run: |
        python -m pip install --upgrade pip
        pip install flet-cli==${{ env.FLET_CLI_VERSION }}
        
    # 5. Ù‚Ø¨ÙˆÙ„ ØªØ±Ø§Ø®ÙŠØµ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø¨Ù†Ø§Ø¡)
    - name: ğŸ” Accept Android Licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    # 6. Ø¨Ù†Ø§Ø¡ APK
    - name: ğŸ”¨ Flet Build APK
      run: |
        # Ù†Ø³ØªØ®Ø¯Ù… --skip-flutter-doctor Ù„Ø£Ù† Ø§Ù„ØªØ«Ø¨ÙŠØª ØªÙ… Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ø¨Ø± flutter.yml
        flet build apk --release --skip-flutter-doctor \
          --build-number $BUILD_NUMBER \
          --build-version $BUILD_VERSION \
          --android-permissions android.permission.READ_CONTACTS=True \
          android.permission.WRITE_CONTACTS=True

    # 7. Ø±ÙØ¹ Ù…Ù„Ù APK
    - name: â¬†ï¸ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: build/app/outputs/flutter-apk/app-release.apk
