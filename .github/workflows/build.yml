name: APK Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù‡Ø°Ù‡ Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ ÙÙŠ Ù†Ø·Ø§Ù‚ env Ø§Ù„Ø¹Ø§Ù…)
  BUILD_NUMBER: 1
  BUILD_VERSION: 1.0.0
  PYTHON_VERSION: 3.11
  FLET_CLI_VERSION: 0.28.3
  FLUTTER_VERSION_TAG: 3.28.0 # Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©

jobs:
  # 1. ØªØ«Ø¨ÙŠØª Flutter: Ù‡Ø°Ø§ job Ø³ÙŠØ³ØªØ¯Ø¹ÙŠ job Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† flutter.yml
  setup_flutter:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # ğŸ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø·ÙˆØ© "run" Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ (Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ env)
    # ÙˆÙ„ÙƒÙ† Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø¨Ø³Ø· Ù‡ÙŠ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ÙƒÙ…Ø§ ÙŠÙ„ÙŠ:
    
    - name: Call Flutter Setup Workflow
      uses: ./.github/workflows/flutter.yml@main 
      with:
        runs-on: ubuntu-latest
        channel: stable
        # *** Ø§Ù„ØªØºÙŠÙŠØ± Ù‡Ù†Ø§: ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙŠØ§Ù‚ Ù…Ø®ØªÙ„Ù ***
        # Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø«Ø§Ø¨ØªØ© (3.28.0)ØŒ ÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ±Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©.
        version: ${{ vars.FLUTTER_VERSION_TAG || env.FLUTTER_VERSION_TAG }} 
        # Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙÙ‹Ø§ ÙÙŠ Ù†Ø·Ø§Ù‚ (workflow level env)ØŒ ÙŠÙÙ…ÙƒÙ† Ø£Ù† ÙŠØ¹Ù…Ù„ ${{ env.FLUTTER_VERSION_TAG }} Ø¥Ø°Ø§ ØªÙ… ØªØ¶Ù…ÙŠÙ†Ù‡ ÙÙŠ JobØŒ Ù„ÙƒÙ† Ø§Ù„Ø£Ù…Ø§Ù† Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„ÙØµÙ„.

  # 2. Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: Ù‡Ø°Ø§ Job Ø³ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Job ØªØ«Ø¨ÙŠØª Flutter
  build:
    needs: [setup_flutter] 
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›‘ Checkout code
      uses: actions/checkout@v4

    # *** ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ«Ø¨ÙŠØª Flutter ÙÙŠ Ù‡Ø°Ø§ Job Ø£ÙŠØ¶Ù‹Ø§ ***
    # Ø¨Ù…Ø§ Ø£Ù† Job Ø§Ù„ØªØ«Ø¨ÙŠØª (setup_flutter) ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¢Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø®ØªÙ„ÙØ©ØŒ 
    # ÙŠØ¬Ø¨ ØªÙƒØ±Ø§Ø± Ø®Ø·ÙˆØ© ØªØ«Ø¨ÙŠØª Flutter ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù€ Job (build) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„Ù‚ÙŠÙ….

    - name: ğŸ¯ Re-Setup Flutter for Build Job
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        flutter-version: ${{ env.FLUTTER_VERSION_TAG }}

    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: âš™ï¸ Install Flet CLI
      run: |
        python -m pip install --upgrade pip
        pip install flet-cli==${{ env.FLET_CLI_VERSION }}
        
    - name: ğŸ” Accept Android Licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: ğŸ”¨ Flet Build APK
      run: |
        flet build apk --release --skip-flutter-doctor \
          --build-number ${{ env.BUILD_NUMBER }} \
          --build-version ${{ env.BUILD_VERSION }} \
          --android-permissions android.permission.READ_CONTACTS=True \
          android.permission.WRITE_CONTACTS=True

    - name: â¬†ï¸ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: build/app/outputs/flutter-apk/app-release.apk